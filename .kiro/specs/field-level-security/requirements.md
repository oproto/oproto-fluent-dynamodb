# Requirements Document

## Introduction

This feature adds field-level security capabilities to Oproto.FluentDynamoDb, enabling developers to protect sensitive data through two mechanisms: exclusion from logging output and optional KMS-based encryption. The logging protection is built into the core library, while encryption support is provided as a separate optional assembly to avoid unnecessary dependencies.

## Glossary

- **FluentDynamoDb**: The core Oproto.FluentDynamoDb library
- **Sensitive Field**: A property marked to be excluded from logging output
- **Encrypted Field**: A property that is encrypted at rest using AWS KMS
- **Data Key**: A symmetric encryption key generated by AWS KMS for encrypting field data
- **Tenant**: A logical grouping of data requiring separate encryption keys
- **KMS**: AWS Key Management Service used for generating and managing data keys
- **Logger**: The IDynamoDbLogger interface used for diagnostic output
- **Encryption Assembly**: The optional Oproto.FluentDynamoDb.Encryption.Kms package

## Requirements

### Requirement 1

**User Story:** As a developer, I want to mark fields as sensitive so that their values are excluded from logging output, ensuring compliance with data protection regulations.

#### Acceptance Criteria

1. WHEN a property is marked with a SensitiveAttribute, THE FluentDynamoDb SHALL exclude the property value from all log messages
2. WHEN logging entity data, THE FluentDynamoDb SHALL replace sensitive field values with a placeholder string "[REDACTED]"
3. THE FluentDynamoDb SHALL apply sensitive field redaction to all logging operations including query results, put operations, and error messages
4. THE FluentDynamoDb SHALL preserve the property name in log output while redacting only the value
5. WHERE the SensitiveAttribute is applied, THE FluentDynamoDb SHALL support the attribute on properties of any serializable type

### Requirement 2

**User Story:** As a developer, I want to encrypt sensitive fields using AWS KMS so that data is protected at rest in DynamoDB without adding dependencies to projects that don't need encryption.

#### Acceptance Criteria

1. THE FluentDynamoDb SHALL provide encryption support through a separate Oproto.FluentDynamoDb.Encryption.Kms assembly
2. WHEN a property is marked with an EncryptedAttribute, THE Encryption Assembly SHALL encrypt the property value before storing in DynamoDB
3. WHEN reading encrypted data, THE Encryption Assembly SHALL decrypt the property value transparently
4. THE Encryption Assembly SHALL use the AWS Encryption SDK with KMS keyring for field encryption
5. THE Encryption Assembly SHALL store encrypted data as binary (B) attribute type in DynamoDB using AWS Encryption SDK message format

### Requirement 3

**User Story:** As a developer working in a multi-context system (multi-tenant, multi-region, etc.), I want to specify different KMS keys per context so that data is encrypted with the appropriate key.

#### Acceptance Criteria

1. THE Encryption Assembly SHALL support a context identifier parameter for key selection
2. WHEN encrypting data, THE Encryption Assembly SHALL invoke a key resolver function to determine the appropriate KMS key ARN
3. THE Encryption Assembly SHALL support configuring the key resolver through dependency injection
4. WHERE no context identifier is provided, THE Encryption Assembly SHALL use a default KMS key ARN
5. THE Encryption Assembly SHALL cache data keys per context to minimize KMS API calls
6. THE Encryption Assembly SHALL use AsyncLocal for ambient context to ensure thread-safety and prevent context leakage

### Requirement 4

**User Story:** As a developer, I want the encryption feature to integrate seamlessly with the source generator so that encryption happens automatically without manual mapper code.

#### Acceptance Criteria

1. WHEN the EncryptedAttribute is detected, THE Source Generator SHALL generate encryption calls in the ToItem mapper method
2. WHEN the EncryptedAttribute is detected, THE Source Generator SHALL generate decryption calls in the FromItem mapper method
3. THE Source Generator SHALL generate code that invokes an IFieldEncryptor interface for encryption operations
4. THE Source Generator SHALL emit a diagnostic warning if EncryptedAttribute is used without the Encryption.Kms package referenced
5. WHERE both SensitiveAttribute and EncryptedAttribute are applied, THE FluentDynamoDb SHALL apply both logging redaction and encryption

### Requirement 5

**User Story:** As a developer, I want clear error messages when encryption operations fail so that I can diagnose and resolve configuration issues.

#### Acceptance Criteria

1. WHEN KMS key access is denied, THE Encryption Assembly SHALL throw a FieldEncryptionException with the key ARN and tenant identifier
2. WHEN data key generation fails, THE Encryption Assembly SHALL throw a FieldEncryptionException with the underlying KMS error
3. WHEN decryption fails due to corrupted data, THE Encryption Assembly SHALL throw a FieldEncryptionException indicating data corruption
4. THE Encryption Assembly SHALL log encryption and decryption operations at Debug level
5. THE Encryption Assembly SHALL log encryption failures at Error level with full context

### Requirement 6

**User Story:** As a developer, I want to configure encryption behavior through options so that I can control caching policies and algorithm settings.

#### Acceptance Criteria

1. THE Encryption Assembly SHALL support configuring data key cache TTL through AwsEncryptionSdkOptions
2. THE Encryption Assembly SHALL default to a 5-minute data key cache TTL
3. THE Encryption Assembly SHALL support disabling caching through EnableCaching option
4. THE Encryption Assembly SHALL NOT allow hardcoding KMS key ARNs in attributes for security reasons
5. THE Encryption Assembly SHALL require KMS keys to be provided through IKmsKeyResolver from secure configuration
6. THE Encryption Assembly SHALL use AWS Encryption SDK's CachingCryptoMaterialsManager with configurable limits for messages and bytes per data key

### Requirement 7

**User Story:** As a developer, I want encrypted data to use industry-standard formats so that it can be decrypted by other AWS services and tools if needed.

#### Acceptance Criteria

1. THE Encryption Assembly SHALL use AWS Encryption SDK message format for all encrypted fields
2. THE Encryption Assembly SHALL include encryption context in encrypted messages for auditability
3. THE Encryption Assembly SHALL use algorithm suites with key commitment by default to prevent key substitution attacks
4. THE Encryption Assembly SHALL store field name and context identifier in the encryption context
5. WHERE encryption context is used, THE Encryption Assembly SHALL validate it matches expected values during decryption

### Requirement 8

**User Story:** As a developer, I want to combine encryption with external blob storage so that large encrypted fields don't exceed DynamoDB item size limits.

#### Acceptance Criteria

1. WHERE a property is marked with both EncryptedAttribute and BlobReferenceAttribute, THE Encryption Assembly SHALL encrypt data before storing it externally
2. WHEN storing encrypted external blobs, THE Encryption Assembly SHALL encrypt first, then delegate to the existing blob storage provider
3. THE Encryption Assembly SHALL integrate with the existing IBlobStorageProvider interface from the advanced-type-system feature
4. WHEN reading encrypted external blobs, THE Encryption Assembly SHALL retrieve the blob then decrypt it transparently
5. THE Encryption Assembly SHALL support automatic external storage when encrypted data exceeds a configurable threshold (even without BlobReferenceAttribute)
6. WHERE automatic external storage is triggered, THE Encryption Assembly SHALL use the configured default blob provider
